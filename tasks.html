<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Task Results</title>

  <!-- Font + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Orienta&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { orienta: ['Orienta', 'sans-serif'] },
          colors: { brandGrey: '#6B7280', brandYellow: '#fedc4b' }
        }
      }
    };
  </script>

  <!-- Optional helper; safe if missing -->
  <script src="./filterState.js" defer></script>

  <style>
    body { font-family: 'Orienta', sans-serif; background:#212121; color:#fff; }
    .tap { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Top bar -->
  <header class="sticky top-0 z-50 bg-[#1B1B1A] backdrop-blur supports-[backdrop-filter]:bg-[#1B1B1A] border-b border-white/10">
    <div class="mx-auto max-w-4xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button type="button" id="backBtn" aria-label="Go back"
          class="tap inline-flex items-center gap-2 rounded px-3 py-2 text-sm font-semibold bg-white text-slate-900 hover:bg-brandYellow focus:outline-none focus:ring-2 focus:ring-white/50">
          ← Back
        </button>

        <button type="button" id="restartBtn"
          class="tap inline-flex items-center gap-2 rounded px-3 py-2 text-sm font-semibold bg-white text-slate-900 hover:bg-brandYellow focus:outline-none focus:ring-2 focus:ring-white/50">
          Restart
        </button>
      </div>

      <button id="toggleButton" type="button"
        class="tap inline-flex items-center gap-2 rounded px-3 py-2 text-sm font-semibold bg-white text-slate-900 hover:bg-brandYellow focus:outline-none focus:ring-2 focus:ring-white/50">
        Show All
      </button>
    </div>
  </header>

  <main class="mx-auto max-w-4xl px-4 py-6">
    <h1 id="selectPrompt" class="text-xl md:text-2xl font-bold tracking-wide mb-4 md:mb-6">CHOOSE A TASK TO PRACTICE AN EXERCISE :</h1>

    <!-- Zero-results helper -->
    <section id="noResults" class="hidden bg-[#1B1B1A] border border-[#5F5F5E] p-4 md:p-5 mb-6">
      <p class="text-base md:text-lg font-semibold mb-2">There are no tasks that directly meet your criteria.</p>
      <p class="text-white/80 mb-4">Let’s broaden your search. Which criteria are you more interested in?</p>
      <div id="keepButtons" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
    </section>

    <div id="taskList" class="divide-y divide-white/10"></div>
  </main>

  <script>
    // ---- Mobile-safe activation (pointerup + click fallback; de-duped) ----
    function onActivate(el, handler) {
      let armed = true;
      const fire = (ev) => { if (!armed) return; armed = false; try { handler(ev); } finally { setTimeout(()=>armed=true, 220); } };
      el.addEventListener('pointerup', fire, { passive: true });
      el.addEventListener('click', fire);
    }

    // ---- Storage (write-through; localStorage wins) ----
    const STORAGE_KEY = 'licensureFilters';
    function lsRead()  { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch { return {}; } }
    function lsWrite(o){ localStorage.setItem(STORAGE_KEY, JSON.stringify(o || {})); }

    function filtersGet() {
      const api = (window.LicensureFilters?.get ? window.LicensureFilters.get() : {}) || {};
      const ls  = lsRead();
      return Object.assign({}, api, ls); // ls overrides on same keys
    }
    function filtersSet(next) {
      try { window.LicensureFilters?.set && window.LicensureFilters.set(next); } catch {}
      lsWrite(next);
      document.dispatchEvent(new CustomEvent('filters:change'));
    }
    function readFilters() {
      const s = filtersGet();
      return {
        competency: s.Competency != null ? Number(s.Competency) : null,
        level: s.Level || null,
        naab: Array.isArray(s.NAAB) ? s.NAAB : (s.NAAB ? [s.NAAB] : []),
        raw: s
      };
    }
    function getRole() {
      const s = filtersGet();
      return s.Role || s.role || localStorage.getItem('selectedRole') || null;
    }

    // ---- Keep-only action ----
    function keepOnly(keepKey) {
      const state = filtersGet();
      ['Competency','Level','NAAB'].forEach(k => { if (k !== keepKey) delete state[k]; });
      filtersSet(state);
      filters = readFilters();
      renderTasks(taskData);
      document.getElementById('taskList')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ---- Page controls ----
    function wireChromeSafeHandlers() {
      onActivate(document.getElementById('backBtn'), () => {
        if (history.length > 1) history.back(); else window.location.href = 'index.html';
      });
      onActivate(document.getElementById('restartBtn'), () => {
        filtersSet({});
        localStorage.removeItem('selectedRole');
        window.location.href = 'index.html';
      });
      onActivate(document.getElementById('toggleButton'), () => {
        showGrey = !showGrey;
        document.getElementById('toggleButton').innerText = showGrey ? 'Hide' : 'Show All';
        const items = document.getElementById('taskList').children;
        for (const el of items) {
          const matched = el.dataset.match === 'true';
          if (!matched) el.classList.toggle('hidden', !showGrey);
        }
      });
    }

    // ---- Data + render ----
    let filters = readFilters();
    let showGrey = false;
    let taskData = [];

    function getNaabArray(raw) {
      if (Array.isArray(raw)) return raw;
      if (typeof raw === 'string') {
        try { return JSON.parse(raw.replace(/'/g, '\"')) || []; }
        catch { return raw.replace(/[\\[\\]\\s'\\\"]/g, '').split(',').filter(Boolean); }
      }
      return [];
    }

    async function loadTasks() {
      // cache-bust to avoid stale JSON in iOS Chrome
      const r = await fetch('task_data.json?v=' + Date.now(), { cache: 'no-store' });
      if (!r.ok) throw new Error('Could not load task_data.json');
      taskData = await r.json();
      renderTasks(taskData);
    }

    function buildKeepButtons(matchedCount) {
      const prompt = document.getElementById('selectPrompt');
      const panel  = document.getElementById('noResults');
      const wrap   = document.getElementById('keepButtons');

      if (matchedCount > 0) {
        prompt.classList.remove('hidden');
        panel.classList.add('hidden');
        wrap.replaceChildren();
        return;
      }

      prompt.classList.add('hidden');
      panel.classList.remove('hidden');
      wrap.replaceChildren();

      const role = (getRole() || '').toLowerCase();
      let pair;
      if (role === 'student')            pair = ['Competency', 'Level'];
      else if (role === 'instructor')    pair = ['NAAB', 'Level'];
      else if (role === 'administrator') pair = ['NAAB', 'Competency'];
      else {
        const picks = [];
        if (filters.competency != null) picks.push('Competency');
        if (filters.level)              picks.push('Level');
        if (Array.isArray(filters.naab) && filters.naab.length) picks.push('NAAB');
        pair = [...new Set([...picks, 'Competency', 'Level', 'NAAB'])].slice(0, 2);
      }

      const labels = {
        Competency: { title: 'NCARB Competency'},
        Level:      { title: 'Ability Level'},
        NAAB:       { title: 'NAAB Criteria'}
      };

      pair.forEach(keepKey => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'tap w-full rounded-lg border border-white/10 bg-white/10 active:bg-white/20 hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/30 px-4 py-3 text-left';
        btn.innerHTML = `
          <div class="text-base md:text-lg font-semibold">${labels[keepKey].title}</div>
        `;
        onActivate(btn, () => keepOnly(keepKey));
        wrap.appendChild(btn);
      });
    }

    function renderTasks(data) {
      const list = document.getElementById('taskList');
      list.innerHTML = '';

      const matched = [];
      const unmatched = [];

      data.forEach((task, index) => {
        const naabArr = getNaabArray(task.NAAB);

        const matchCompetency = (filters.competency != null && filters.competency !== '')
          ? Number(task.Competency) === Number(filters.competency) : true;

        const matchLevel = (filters.level != null && filters.level !== '')
          ? task.Level === filters.level : true;

        const matchNaab = (Array.isArray(filters.naab) && filters.naab.length > 0)
          ? filters.naab.some(code => naabArr.includes(code)) : true;

        const meets = matchCompetency && matchLevel && matchNaab;
        (meets ? matched : unmatched).push({ task, index, meets });
      });

      // Zero-match UX
      buildKeepButtons(matched.length);

      // Render matched (colored) first, then unmatched (grey)
      [...matched, ...unmatched].forEach(({ task, index, meets }) => {
        const fontColor = meets ? task.Color : '#6B7280';
        const hasDetails = Boolean(task['TASK DETAILS']);
        const detailId = `details-${index}`;

        const wrap = document.createElement('div');
        wrap.className = 'py-4';
        wrap.dataset.match = String(meets);

        const row = document.createElement('button');
        row.type = 'button';
        row.className = 'tap w-full text-left';
        row.setAttribute('aria-controls', detailId);
        row.setAttribute('aria-expanded', 'false');
        onActivate(row, () => toggleDetails(detailId, row));

        const text = document.createElement('span');
        text.className = 'text-base md:text-lg';
        text.style.color = fontColor;
        text.textContent = task.Task;
        row.appendChild(text);

        if (hasDetails) {
          row.appendChild(document.createTextNode(' '));
          const arrow = document.createElement('span');
          arrow.style.color = fontColor;
          arrow.textContent = '↓';
          arrow.dataset.arrow = 'true';
          row.appendChild(arrow);
        }

        const details = document.createElement('div');
        details.id = detailId;
        details.className = 'hidden mt-1 pl-4 max-w-prose';
        if (hasDetails) {
          const p = document.createElement('p');
          p.className = 'text-sm leading-relaxed text-white/80';
          p.textContent = task['TASK DETAILS'];
          details.appendChild(p);
        }

        if (!meets && !showGrey) wrap.classList.add('hidden');

        wrap.appendChild(row);
        if (hasDetails) wrap.appendChild(details);
        list.appendChild(wrap);
      });
    }

    function toggleDetails(id, btn) {
      const panel = document.getElementById(id);
      if (!panel) return;
      const isHidden = panel.classList.contains('hidden');
      panel.classList.toggle('hidden');
      btn?.setAttribute('aria-expanded', String(isHidden));
      const arrow = btn?.querySelector('[data-arrow]');
      if (arrow) arrow.textContent = isHidden ? '↑' : '↓';
    }

    // ---- Boot after DOM is ready (prevents race with defer'ed scripts on iOS Chrome) ----
    function boot() {
      wireChromeSafeHandlers();
      loadTasks();
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot, { once: true });
    } else {
      boot();
    }
  </script>
</body>
</html>
